# Copyright 2017, Google, Inc.
# Licensed under the Apache License, Version 2.0 (the "License")
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# See:
#
#  https://circleci.com/docs/configuration/
#  https://circleci.com/docs/install-and-use-yarn/

machine:
  node:
    version: 6.10.2
  services:
    - redis
    - memcached

# Use for broader build-related configuration
general:
  branches:
    ignore:
      - gh-pages

# Install your project's language-specific dependencies
dependencies:
  pre:
    - yarn global add nyc codecov @google-cloud/nodejs-repo-tools
  override:
    - yarn install
  post:
    - echo $KEYFILE > /home/ubuntu/nodejs-docs-samples/key.json
    - gcloud auth activate-service-account --key-file /home/ubuntu/nodejs-docs-samples/key.json || true
  cache_directories:
    - ~/.cache/yarn

# Run your tests
test:
  override:
    - samples test install -l=functions/background
    - samples test install -l=functions/datastore
    - samples test install -l=functions/errorreporting
    - samples test install -l=functions/gcs
    - samples test install -l=functions/helloworld
    - samples test install -l=functions/http
    - samples test install -l=functions/log
    - samples test install -l=functions/ocr/app
    - samples test install -l=functions/pubsub
    - samples test install -l=functions/sendgrid
    - samples test install -l=functions/slack
    - samples test install -l=functions/uuid
    - samples test install -l=vision
    - yarn run cover
    - samples test build -l=appengine/analytics --async
    # TODO: Add env vars to CI environment
    # - samples test build -l=appengine/cloudsql --async
    - samples test build -l=appengine/datastore --async
    - samples test build -l=appengine/endpoints --async
    - samples test build -l=appengine/errorreporting --async
    - samples test build -l=appengine/hello-world --async
    - samples test build -l=appengine/mailjet --async
    - samples test build -l=bigquery --async
    - samples test build -l=computeengine --async
    - samples test build -l=containerengine/hello-world --async
    - samples test build -l=datastore --async
    - samples test build -l=debugger --async
    - samples test build -l=dlp --async
    - samples test build -l=dns --async
    - samples test build -l=endpoints/getting-started --async
    # TODO: Update repo tools to accept list of environment variables that must
    #       be set for the build to work.
    # - samples test build -l=endpoints/getting-started-grpc --async
    - samples test build -l=kms --async
    - samples test build -l=language --async
    - samples test build -l=language/slackbot --async
    - samples test build -l=logging --async
    - samples test build -l=monitoring --async
    - samples test build -l=prediction --async
    - samples test build -l=pubsub --async
    - samples test build -l=resource --async
    - samples test build -l=spanner --async
    - samples test build -l=speech --async
    - samples test build -l=storage --async
    - samples test build -l=trace --async
    - samples test build -l=translate --async
    # TODO: This build times out. Does video need more than 10 minutes?
    # - samples test build -l=video --async
    # TODO: Repo tools doesn't support Redis in build container yet.
    #       When this is done, remove Vision from main system tests.
    # - samples test build -l=vision --async
  post:
    - nyc report --reporter=lcov > coverage.lcov && codecov || true
